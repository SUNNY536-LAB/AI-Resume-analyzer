{% extends "base.html" %}

{% block title %}Analysis Report - ResumeAI{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .glass-panel {
    background: #151b2b;
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .score-card {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Grade Badge */
  .grade-badge {
    font-size: 6rem;
    font-weight: 800;
    line-height: 1;
    background: linear-gradient(to bottom right, #ffffff, #94a3b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.1));
  }

  .grade-A {
    background: linear-gradient(to bottom right, #4ade80, #22c55e);
    -webkit-background-clip: text;
  }

  .grade-B {
    background: linear-gradient(to bottom right, #60a5fa, #3b82f6);
    -webkit-background-clip: text;
  }

  .grade-C {
    background: linear-gradient(to bottom right, #facc15, #eab308);
    -webkit-background-clip: text;
  }

  .grade-D {
    background: linear-gradient(to bottom right, #f87171, #ef4444);
    -webkit-background-clip: text;
  }

  .skill-match {
    border-left: 3px solid #10b981;
    background: rgba(16, 185, 129, 0.05);
  }

  .skill-missing {
    border-left: 3px solid #ef4444;
    background: rgba(239, 68, 68, 0.05);
  }
</style>
{% endblock %}

{% block content %}
{% set score = r.total_score %}
{% set grade = 'A' if score >= 90 else 'B' if score >= 75 else 'C' if score >= 60 else 'D' %}
{% set status_text = 'Interview Ready' if score >= 90 else 'Strong Contender' if score >= 75 else 'Needs Improvement' if
score >= 60 else 'Not Ready' %}
{% set status_color = 'text-green-400' if score >= 90 else 'text-blue-400' if score >= 75 else 'text-yellow-400' if
score >= 60 else 'text-red-400' %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

  <!-- Header / Action Bar -->
  <div
    class="glass-panel p-6 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 pointer-events-none"></div>
    <div class="relative z-10 text-center sm:text-left">
      <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-indigo-200 mb-1">
        AI Analysis Report
      </h1>
      <div
        class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-sm text-gray-400">
        <i class="fa-solid fa-crosshairs text-indigo-400"></i>
        <span>Target: <span class="text-indigo-300 font-medium">{{ "Specific Job Description" if r.missing_keywords else
            "General Industry Standards" }}</span></span>
      </div>
    </div>

    <a href="/analyze"
      class="relative z-10 group px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-bold transition-all hover:shadow-[0_0_20px_rgba(99,102,241,0.5)] flex items-center gap-2 overflow-hidden">
      <div
        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-shimmer">
      </div>
      <i class="fa-solid fa-satellite-dish group-hover:rotate-12 transition-transform"></i>
      <span>Scan New Resume</span>
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

    <!-- LEFT: Report Card (4 cols) -->
    <div class="lg:col-span-4 space-y-6">
      <!-- Main Grade Card -->
      <div
        class="glass-panel p-8 text-center relative overflow-hidden flex flex-col items-center justify-center shadow-[0_0_40px_rgba(79,70,229,0.15)] hover:shadow-[0_0_60px_rgba(79,70,229,0.3)] transition-shadow duration-500 border-indigo-500/20">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>

        <h3 class="text-gray-400 text-sm uppercase tracking-wider font-semibold mb-6">ATS Score</h3>

        <!-- Circular Gauge -->
        {% set ring_color = '#22c55e' if score >= 90 else '#3b82f6' if score >= 75 else '#eab308' if score >= 60 else
        '#ef4444' %}
        <div class="relative w-40 h-40 mb-6 flex items-center justify-center rounded-full"
          style="background: conic-gradient({{ ring_color }} {{ score }}%, rgba(255,255,255,0.05) 0%); box-shadow: 0 0 30px {{ ring_color }}30;">

          <!-- Inner Circle -->
          <div class="absolute inset-2 bg-[#151b2b] rounded-full flex flex-col items-center justify-center z-10">
            <span class="text-5xl font-bold text-white">{{ score }}</span>
            <span class="text-xs text-gray-500 uppercase tracking-widest mt-1">Score</span>
          </div>
        </div>

        <div class="{{ status_color }} text-xl font-bold mb-2">{{ status_text }}</div>
        <p class="text-gray-500 text-xs">Based on 6 weighted factors</p>
      </div>

      <!-- Breakdown Chart (Strict Scoring) -->
      <div
        class="glass-panel p-5 flex flex-col gap-1 shadow-[0_0_30px_rgba(99,102,241,0.1)] hover:shadow-[0_0_50px_rgba(99,102,241,0.2)] transition-shadow duration-500">
        <h4 class="text-gray-300 font-semibold mb-0 text-center text-sm">Performance Breakdown</h4>

        <!-- Radar Chart (Flexible container) -->
        <div class="relative w-full flex items-center justify-center h-[140px] -my-2">
          <canvas id="radarChart"></canvas>
        </div>

        <!-- Detailed Progress Bars -->
        <div class="space-y-4 border-t border-white/5 pt-4">
          <!-- Keywords (45%) -->
          <div class="group">
            <div class="flex justify-between text-xs font-semibold mb-1 tracking-wide">
              <span class="text-indigo-200">Keywords (45%)</span>
              <span class="text-white">{{ r.breakdown.keywords }}%</span>
            </div>
            <div class="w-full bg-gray-900/50 rounded-full h-2 border border-white/5 overflow-hidden">
              <div
                class="bg-gradient-to-r from-indigo-500 to-blue-500 h-full rounded-full shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all duration-1000"
                style="width: {{ r.breakdown.keywords }}%"></div>
            </div>
          </div>

          <!-- Skills (15%) -->
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-400">Skills Section (15%)</span>
              <span class="text-white">{{ r.breakdown.skills }}%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-1.5">
              <div class="bg-blue-500 h-1.5 rounded-full" style="width: {{ r.breakdown.skills }}%"></div>
            </div>
          </div>

          <!-- Experience (15%) -->
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-400">Experience & Impact (15%)</span>
              <span class="text-white">{{ r.breakdown.experience }}%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-1.5">
              <div class="bg-purple-500 h-1.5 rounded-full" style="width: {{ r.breakdown.experience }}%"></div>
            </div>
          </div>

          <!-- Formatting (10%) -->
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-400">Formatting (10%)</span>
              <span class="text-white">{{ r.breakdown.formatting }}%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-1.5">
              <div class="bg-amber-500 h-1.5 rounded-full" style="width: {{ r.breakdown.formatting }}%"></div>
            </div>
          </div>

          <!-- Education (10%) & Contact (5%) -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Education</span>
                <span class="text-white">{{ r.breakdown.education }}%</span>
              </div>
              <div class="w-full bg-gray-800 rounded-full h-1.5">
                <div class="bg-teal-500 h-1.5 rounded-full" style="width: {{ r.breakdown.education }}%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Contact</span>
                <span class="text-white">{{ r.breakdown.contact }}%</span>
              </div>
              <div class="w-full bg-gray-800 rounded-full h-1.5">
                <div class="bg-rose-500 h-1.5 rounded-full" style="width: {{ r.breakdown.contact }}%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT: Action Plan (8 cols) -->
    <div class="lg:col-span-8 space-y-6">

      <!-- 1. PRIORITY BOX (The "Fix This First" Section) -->
      <!-- 1. PRIORITY BOX (The "Fix This First" Section) -->
      <div class="glass-panel p-8 relative overflow-hidden group">
        <div class="absolute inset-0 bg-gradient-to-r from-orange-500/10 to-red-500/10 opacity-50"></div>
        <div
          class="absolute -top-10 -right-10 w-40 h-40 bg-orange-500/20 rounded-full blur-3xl group-hover:bg-orange-500/30 transition-all duration-700">
        </div>

        <h3 class="relative z-10 text-xl font-bold text-white mb-6 flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center shadow-lg shadow-orange-500/20">
            <i class="fa-solid fa-fire text-white"></i>
          </div>
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-200 to-red-200">Top Priorities</span>
        </h3>

        <div class="relative z-10 space-y-4">
          {% if r.priorities %}
          {% for p in r.priorities %}
          <div
            class="group/item hover:scale-[1.02] transition-transform duration-300 bg-gray-900/40 p-5 rounded-xl flex items-start gap-4 border border-white/5 hover:border-orange-500/30 hover:shadow-[0_0_15px_rgba(249,115,22,0.1)]">
            <div
              class="mt-1 w-8 h-8 rounded-full border border-white/10 flex items-center justify-center {{ p.color }} bg-white/5 group-hover/item:scale-110 transition-transform">
              <i class="fa-solid {{ p.icon }} text-sm"></i>
            </div>
            <div>
              <span class="text-gray-200 font-medium block mb-1 group-hover/item:text-orange-200 transition-colors">{{
                p.text }}</span>
              <span class="text-xs text-gray-500 uppercase tracking-wider font-bold">Recommended Action</span>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div
            class="bg-gradient-to-r from-green-500/10 to-teal-500/10 p-6 rounded-xl border border-green-500/20 text-center">
            <div
              class="w-16 h-16 mx-auto bg-green-500/20 rounded-full flex items-center justify-center mb-4 text-green-400">
              <i class="fa-solid fa-check text-3xl"></i>
            </div>
            <h4 class="text-green-400 font-bold text-lg mb-1">Resume Optimized!</h4>
            <p class="text-green-300/60 text-sm">You are ready to apply.</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- 2. SKILL GAP ANALYSIS (Split View) -->
      <!-- 2. SKILL GAP ANALYSIS (Split View) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Missing Skills -->
        <div
          class="glass-panel p-6 border-t-2 border-t-red-500 shadow-[0_0_40px_rgba(239,68,68,0.3),inset_0_0_20px_rgba(239,68,68,0.1)] hover:shadow-[0_0_80px_rgba(239,68,68,0.5),inset_0_0_30px_rgba(239,68,68,0.2)] transition-all duration-500 relative overflow-hidden group border-red-500/30">
          <div class="absolute -top-10 -left-10 w-32 h-32 bg-red-500/15 rounded-full blur-3xl animate-pulse"></div>
          <h4
            class="text-red-400 font-bold mb-6 flex items-center gap-2 text-sm uppercase tracking-wider relative z-10">
            <i class="fa-solid fa-triangle-exclamation text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.8)]"></i>
            Missing Skills
          </h4>
          {% if r.missing_keywords %}
          <div class="flex flex-wrap gap-2">
            {% for kw in r.missing_keywords %}
            <div
              class="group px-3 py-2 bg-red-500/5 border border-red-500/20 hover:border-red-500/50 rounded-lg text-red-300 transition-all cursor-default">
              <span class="text-xs font-semibold mr-2 opacity-50 group-hover:opacity-100 transition-opacity"><i
                  class="fa-solid fa-xmark"></i></span>
              <span class="font-medium text-sm">{{ kw }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-8">
            <div
              class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-800/50 text-gray-600 mb-3">
              <i class="fa-solid fa-check-double text-xl"></i>
            </div>
            <p class="text-gray-500 text-sm">No critical gaps found.</p>
          </div>
          {% endif %}
        </div>

        <!-- Matched Skills -->
        <div
          class="glass-panel p-6 border-t-2 border-t-green-500 shadow-[0_0_40px_rgba(34,197,94,0.3),inset_0_0_20px_rgba(34,197,94,0.1)] hover:shadow-[0_0_80px_rgba(34,197,94,0.5),inset_0_0_30px_rgba(34,197,94,0.2)] transition-all duration-500 relative overflow-hidden group border-green-500/30">
          <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-500/15 rounded-full blur-3xl animate-pulse"></div>
          <h4
            class="text-green-400 font-bold mb-6 flex items-center gap-2 text-sm uppercase tracking-wider relative z-10">
            <i class="fa-solid fa-check-circle text-green-500 drop-shadow-[0_0_10px_rgba(34,197,94,0.8)]"></i> Matched
            Skills
          </h4>
          {% if r.present_keywords %}
          <div class="flex flex-wrap gap-2">
            {% for kw in r.present_keywords %}
            <div
              class="px-3 py-2 bg-green-500/5 border border-green-500/20 rounded-lg text-green-300 flex items-center gap-2">
              <i
                class="fa-solid fa-check text-[10px] bg-green-500/20 p-1 rounded-full w-4 h-4 flex items-center justify-center"></i>
              <span class="font-medium text-sm">{{ kw }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-gray-500 text-sm italic">No specific skills extracted.</p>
          {% endif %}
        </div>
      </div>

      <!-- 3. IMPACT HIGHLIGHTS -->
      <!-- 3. IMPACT HIGHLIGHTS -->
      {% if r.impacts %}
      <div class="glass-panel p-6 relative overflow-hidden">
        <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-purple-500/10 rounded-full blur-3xl"></div>
        <h4 class="relative z-10 text-purple-300 font-bold mb-4 flex items-center gap-2">
          <i class="fa-solid fa-star text-purple-500 glow-text"></i> High Impact Highlights
        </h4>
        <div class="relative z-10 space-y-3">
          {% for imp in r.impacts %}
          <div
            class="p-4 bg-gray-900/50 border border-purple-500/20 rounded-xl text-gray-300 text-sm italic flex gap-3">
            <i class="fa-solid fa-quote-left text-purple-500/40 text-lg"></i>
            <span>{{ imp }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

    </div>
  </div>

  <!-- 3. DEEP DIVE SECTION (SCORE INSPECTOR) -->
  <div
    class="glass-panel p-8 mt-8 relative overflow-hidden shadow-[0_0_50px_rgba(79,70,229,0.15)] hover:shadow-[0_0_80px_rgba(79,70,229,0.25)] transition-shadow duration-500">
    <div class="absolute inset-0 bg-gradient-to-b from-indigo-900/10 to-transparent"></div>

    <div class="relative z-10 flex flex-col sm:flex-row justify-between items-end mb-8 border-b border-white/5 pb-6">
      <div>
        <h3 class="text-2xl font-bold text-white mb-2 flex items-center gap-3">
          <span
            class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-sm shadow-lg shadow-indigo-500/30">
            <i class="fa-solid fa-magnifying-glass-chart text-white"></i>
          </span>
          Deep Dive Inspector
        </h3>
        <p class="text-gray-400 text-sm">Detailed breakdown of scoring factors and improvement areas.</p>
      </div>
      <div class="hidden sm:block text-right">
        <div class="text-xs text-gray-500 uppercase tracking-widest font-semibold mb-1">Total Issues Found</div>
        <div class="text-white font-mono text-xl">{{ 100 - r.total_score if r.total_score < 100 else 0 }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 relative z-10">

        <!-- Left Column: Specific Category Fixes -->
        <div class="space-y-6 flex-1 shadow-[0_0_30px_rgba(79,70,229,0.1)] p-4 rounded-3xl border border-indigo-500/10">
          {% for category, issues in r.deep_dive.items() %}
          {% if issues %}
          <div class="bg-gray-900/30 rounded-2xl p-1 border border-white/5 hover:border-white/10 transition-colors">
            <div class="px-5 py-3 flex justify-between items-center border-b border-white/5 mb-2">
              <h4 class="text-indigo-200 font-semibold capitalize flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>
                {{ category }}
              </h4>
              <span class="text-xs font-mono text-red-300 bg-red-500/10 px-2 py-1 rounded border border-red-500/20">
                -{{ 100 - r.breakdown[category] }} pts
              </span>
            </div>
            <div class="p-2 space-y-1">
              {% for issue in issues %}
              <div class="flex gap-3 items-start p-3 hover:bg-white/5 rounded-xl transition-colors">
                <div
                  class="mt-0.5 min-w-[20px] h-5 rounded-full bg-red-500/10 text-red-400 flex items-center justify-center text-xs">
                  <i class="fa-solid fa-xmark"></i>
                </div>
                <p class="text-sm text-gray-400 leading-relaxed">{{ issue }}</p>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% endfor %}

          <!-- Fallback if perfect -->
          {% if r.total_score == 100 %}
          <div
            class="text-center py-12 bg-gradient-to-br from-yellow-500/5 to-transparent rounded-2xl border border-yellow-500/10">
            <div
              class="w-20 h-20 mx-auto bg-gradient-to-br from-yellow-400 to-amber-600 rounded-full flex items-center justify-center mb-6 shadow-xl shadow-yellow-500/20">
              <i class="fa-solid fa-trophy text-white text-3xl"></i>
            </div>
            <h3 class="text-white font-bold text-xl mb-2">Flawless Resume!</h3>
            <p class="text-gray-400">No automated issues detected. You are a top candidate!</p>
          </div>
          {% endif %}
        </div>

        <!-- Right Column: Strengths & Impact -->
        <div
          class="bg-gradient-to-b from-gray-900/50 to-transparent rounded-3xl p-8 border border-purple-500/30 shadow-[0_0_40px_rgba(168,85,247,0.15)] hover:shadow-[0_0_60px_rgba(168,85,247,0.3)] transition-all duration-500 relative overflow-hidden group">
          <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl animate-pulse">
          </div>
          <h4
            class="text-purple-300 font-bold mb-6 flex items-center gap-2 uppercase text-xs tracking-widest border-b border-white/5 pb-4">
            <i class="fa-solid fa-star text-purple-500"></i> Best Performing Lines
          </h4>

          {% if r.impacts %}
          <div class="space-y-4">
            {% for imp in r.impacts[:5] %}
            <div
              class="relative p-4 bg-gray-800/40 rounded-xl border border-purple-500/10 hover:border-purple-500/30 transition-all group">
              <i
                class="fa-solid fa-quote-left absolute top-4 left-4 text-purple-500/20 text-3xl -z-10 group-hover:text-purple-500/30 transition-colors"></i>
              <p class="text-gray-300 text-sm italic pl-8 relative z-10">"{{ imp }}"</p>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-10 opacity-50">
            <i class="fa-brands fa-searchengin text-4xl mb-3 text-gray-600"></i>
            <p class="text-gray-500 text-sm">No specific impact lines highlighted.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <script>
    // Radar Chart Logic (Updated for 6 Categories)
    const ctx = document.getElementById('radarChart').getContext('2d');
    const data = {
      labels: ['Keywords', 'Skills', 'Experience', 'Formatting', 'Education', 'Contact'],
      datasets: [{
        label: 'Your Resume',
        data: [
          {{ r.breakdown.keywords |default(0) }},
      {{ r.breakdown.skills |default(0) }},
      {{ r.breakdown.experience |default (0) }},
    { { r.breakdown.formatting |default (0) } },
    { { r.breakdown.education |default (0) } },
    { { r.breakdown.contact |default (0) } }
        ],
    fill: true,
      backgroundColor: 'rgba(99, 102, 241, 0.2)',
        borderColor: 'rgb(99, 102, 241)',
          pointBackgroundColor: 'rgb(99, 102, 241)',
            pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(99, 102, 241)'
      }]
    };

    new Chart(ctx, {
      type: 'radar',
      data: data,
      options: {
        scales: {
          r: {
            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            pointLabels: {
              color: '#94a3b8',
              font: { size: 10 }
            },
            ticks: { display: false, backdropColor: 'transparent' },
            suggestedMin: 0,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: { display: false }
        },
        maintainAspectRatio: false
      }
    });
  </script>
  {% endblock %}